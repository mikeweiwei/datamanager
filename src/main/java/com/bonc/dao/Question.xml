<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bonc.dao.Question">


	
	<!-- 按日统计累计用户数 -->
	<select id="getUserTotleByDay" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(DISTINCT(USERID)) AS totle,date_format(CREATE_DATE, '%Y-%m-%d') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num DAY),'%Y-%m-%d') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num DAY) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	<!-- 按日统计累计累计问答数 -->
	<select id="getQaTotleByDay" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%Y-%m-%d') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num DAY),'%Y-%m-%d') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num DAY) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	<!-- 按日统计解决问答数  -->
	<select id="getSolveQaByDay" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%Y-%m-%d') AS time FROM
	s_qa_history WHERE ISSOLVED = 1 AND date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num DAY),'%Y-%m-%d') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num DAY) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	
	<!-- 按月统计累计用户数 -->
	<select id="getUserTotleByMo" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(DISTINCT(USERID)) AS totle,date_format(CREATE_DATE, '%Y-%m') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num MONTH),'%Y-%m') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num MONTH) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	<!-- 按月统计累计累计问答数 -->
	<select id="getQaTotleByMo" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%Y-%m') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num MONTH),'%Y-%m') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num MONTH) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	<!-- 按月统计解决问答数  -->
	<select id="getSolveQaByMo" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%Y-%m') AS time FROM
	s_qa_history WHERE ISSOLVED = 1 AND date_format(CREATE_DATE, '%Y-%m') BETWEEN #{startTime} AND #{endTime} GROUP BY date_format(CREATE_DATE, '%Y-%m')
	) a RIGHT JOIN (SELECT @num :=@num + 1,date_format(adddate(#{startTime},INTERVAL @num MONTH),'%Y-%m') AS time FROM s_qa_history,
	(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num MONTH) < date_format(#{endTime}, '%Y-%m-%d')) b ON
	a.time = b.time
	]]>
	</select>
	
	
	
	<!-- 按小时统计累计用户数 -->
	<select id="getUserTotleByH" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(DISTINCT(USERID)) AS totle,date_format(CREATE_DATE, '%H') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') = #{startTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d %H')
	) a RIGHT JOIN (select @num:=@num+1 as time from s_qa_history,(select @num:=-1) t where @num < 23) b ON
	a.time = b.time 
	ORDER BY b.time
	]]>
	</select>
	
	<!-- 按小时统计累计累计问答数 -->
	<select id="getQaTotleByH" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%H') AS time FROM
	s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') = #{startTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d %H')
	) a RIGHT JOIN (select @num:=@num+1 as time from s_qa_history,(select @num:=-1) t where @num < 23) b ON
	a.time = b.time
	ORDER BY b.time
	]]>
	</select>
	
	<!-- 按小时统计解决问答数  -->
	<select id="getNoSolveQaByH" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT ifnull(totle,0) as totle,b.time FROM ( SELECT COUNT(RECARD_ID) AS totle,date_format(CREATE_DATE, '%H') AS time FROM
	s_qa_history WHERE ISSOLVED = 0 AND  date_format(CREATE_DATE, '%Y-%m-%d') = #{startTime} GROUP BY date_format(CREATE_DATE, '%Y-%m-%d %H')
	) a RIGHT JOIN (select @num:=@num+1 as time from s_qa_history,(select @num:=-1) t where @num < 23) b ON
	a.time = b.time
	ORDER BY b.time
	]]>
	</select>
	
	
	<!-- 累计问答数和用户数 -->
	<select id="getTotleByUserAndQa" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	select COUNT(DISTINCT(USERID)) as usertotle,COUNT(RECARD_ID) as qatotle from s_qa_history where 1=1 
	]]>
	<if test="startTime != null"> 
	AND date_format(CREATE_DATE, '%Y-%m-%d') = #{startTime}
	</if>
	</select>
	
	<!-- 累计解决问答数 -->
	<select id="getTotleBySolveQa" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	select COUNT(RECARD_ID) as solve_qa_totle from s_qa_history where ISSOLVED = 1 
	]]>
	<if test="startTime != null"> 
	AND date_format(CREATE_DATE, '%Y-%m-%d') = #{startTime}
	</if>
	</select>
	
	<!-- 常见问题分类统计 -->
	<select id="getQuestionCount" parameterType="java.lang.String" resultType="java.util.HashMap">
	SELECT COUNT(MATCH_QUESTID) as totle , MATCH_QUESTID as QUESTID from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} and #{endTime} GROUP BY MATCH_QUESTID
	</select>
	
	<!-- 解决未解决统计 -->
	<select id="getSolveOrNoCount" parameterType="java.lang.String" resultType="java.util.HashMap">
	SELECT COUNT(ISSOLVED) as totle , ISSOLVED as solve from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} and #{endTime} GROUP BY ISSOLVED
	</select>
	
	<!-- 用户满意度分析 
	SELECT a.1,IfNULL(b.0, 0) AS '0',a.times FROM ( SELECT COUNT(RECARD_ID) AS '1',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime} AND SATISIFIED_SCORE >= 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) a
	LEFT JOIN ( SELECT COUNT(RECARD_ID) AS '0',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d')
	BETWEEN #{startTime} AND #{endTime} AND SATISIFIED_SCORE < 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) b ON a.times = b.times
	-->
	<select id="getSatisifiedCount" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT
	c.times as time,ifnull(d.1,0) as '1',ifnull(d.0,0) as '0' FROM(SELECT @num :=@num + 1 AS id,date_format(adddate(#{startTime},INTERVAL @num DAY),'%Y-%m-%d') AS times FROM
	s_qa_history,(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num DAY) < date_format(#{endTime}, '%Y-%m-%d')) c LEFT JOIN (SELECT a.1,
	IfNULL(b.0, 0) AS '0',a.times as times FROM (SELECT COUNT(RECARD_ID) AS '1',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime} AND SATISIFIED_SCORE >= 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) a
	LEFT JOIN (SELECT COUNT(RECARD_ID) AS '0',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	AND SATISIFIED_SCORE < 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) b ON a.times = b.times) d ON c.times = d.times
	]]>
	</select>
	
	<!-- 地域top10 -->
	<select id="getCityCount" parameterType="java.lang.String" resultType="java.util.HashMap">
	SELECT
		COUNT(b.LOCATION) AS totle,
		b.LOCATION AS city
	FROM
		s_qa_history a ,s_user_info b
	WHERE
		date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime}
	AND #{endTime}
	AND a.USERID = b.USER_ID
	GROUP BY
		b.LOCATION
	LIMIT 0,10	
	</select>
	
	<!-- 常见问题分类统计 1.统计 2.展示   参数时间-->
	<select id="getQuestionType" parameterType="java.lang.String" resultType="java.util.HashMap">
		select * from s_qa_history 
		where  date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	</select>
	
	<insert id="insertData" >
   		<selectKey keyProperty="ID" order="AFTER" resultType="java.lang.Integer">
            select LAST_INSERT_ID()
        </selectKey>
  		insert into s_qa_history(USERID,INPUT,OUTPUT,MATCH_QUESTID,MATCH_QUESTION,MATCH_TYPEID,MATCH_TYPE,ISSOLVED,SATISIFIED_SCORE,CREATE_DATE) 
  		values(FLOOR(2000 + RAND() * 1001),#{INPUT},#{OUTPUT},
  		#{MATCH_QUESTID},#{MATCH_QUESTION},#{MATCH_TYPEID},#{MATCH_TYPE},
  		FLOOR(RAND() * 2),FLOOR(50 + RAND() * 51),
  		concat(floor(2017+rand()*2),'-',floor(3+rand()*10),'-',floor(2+rand()*28)," ", floor(10+rand()*10),':',floor(10+rand()*49),':',floor(10+rand()*49)))
   </insert>
   
	
	<!-- 问答记录总数
	</if> -->
	<select id="getQaListTotle" parameterType="java.lang.String" resultType="java.util.HashMap">
	SELECT COUNT(1) as totle from s_qa_history WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN  #{startTime} AND  #{endTime} 
	<if test="MATCHTYPEID != null"> 
	AND MATCH_TYPEID in 
	<foreach collection="MATCHTYPEID" item="one" index="index"
            open="(" close=")" separator=",">
            #{one}
    </foreach>
    </if>
	<if test="ISSOLVED != null and ISSOLVED != ''"> 
	AND ISSOLVED = #{ISSOLVED}
	</if>
	<if test="OUTPUT != null and OUTPUT != ''"> 
	AND OUTPUT LIKE concat(concat('%',#{OUTPUT}),'%')
	</if>
	<if test="INPUT != null and INPUT != ''"> 
	AND INPUT LIKE concat(concat('%',#{INPUT}),'%')
	</if>
	<!-- 问答记数list -->
	</select>
	<select id="getQaList" parameterType="java.lang.String" resultType="java.util.LinkedHashMap">
	SELECT RECARD_ID,USERID,INPUT,OUTPUT,MATCH_TYPE,ISSOLVED,date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') as time from s_qa_history WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN  #{startTime} AND  #{endTime} 
	<if test="MATCHTYPEID != null"> 
	AND MATCH_TYPEID in 
	<foreach collection="MATCHTYPEID" item="one" index="index"
            open="(" close=")" separator=",">
            #{one}
    </foreach>
    </if>
	<if test="ISSOLVED != null and ISSOLVED != ''"> 
	AND ISSOLVED = #{ISSOLVED}
	</if>
	<if test="OUTPUT != null and OUTPUT != ''"> 
	AND OUTPUT LIKE concat(concat('%',#{OUTPUT}),'%')
	</if>
	<if test="INPUT != null and INPUT != ''"> 
	AND INPUT LIKE concat(concat('%',#{INPUT}),'%')
	</if>
	<if test="excel == null">
	LIMIT #{page},#{size}
	</if>
	</select>
	
	<select id="getmenu"  resultType="java.util.HashMap">
		select DISTINCT(MATCH_TYPE), MATCH_TYPEID from s_qa_history
	</select>
	
	<select id="getDataList"  resultType="java.util.HashMap">
		select RECARD_ID as id,USERID,INPUT,OUTPUT,MATCH_QUESTID,MATCH_QUESTION,MATCH_TYPEID,MATCH_TYPE,ISSOLVED
		,SATISIFIED_SCORE,date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') as time from s_qa_history
		WHERE date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN  #{startTime} AND  #{endTime} 
	</select>
	
	<!-- 用户分析 -->
	<select id="getQaTypeAnalyse" parameterType="java.lang.String" resultType="java.util.HashMap">
		select COUNT(1) as totle ,MATCH_TYPE,MATCH_TYPEID from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') BETWEEN #{startTime} AND #{endTime} GROUP BY MATCH_TYPE;
	</select>
	<select id="getQaTypeAnalyseList" resultType="java.util.LinkedHashMap">
	select RECARD_ID,USERID,INPUT,OUTPUT,MATCH_TYPE,MATCH_TYPEID,date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') as time from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime}
	<if test="excel == null">
	LIMIT #{page},#{size}
	</if>
	</select>
	<select id="getQaTypeAnalyseListTotle" resultType="java.util.HashMap">
	select COUNT(1) as totle from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime}
	</select>
	
	
	<select id="getIsSolveAnalyse" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	select COUNT(1) as totle,ISSOLVED as SATISIFIED from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime} GROUP BY ISSOLVED
	]]>
	</select>
	
	<select id="getIsSolveAnalyseList" resultType="java.util.LinkedHashMap">
	<![CDATA[
	select RECARD_ID,INPUT,OUTPUT,ISSOLVED,date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') as time from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime} 
	]]>
	<if test="excel == null">
	LIMIT #{page},#{size}
	</if>
	</select>
	<select id="getIsSolveAnalyseListTotle" resultType="java.util.HashMap">
	<![CDATA[
	select COUNT(1) as totle from s_qa_history where date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime} 
	]]>
	</select>
	
	
	<select id="getSatisifiedAnalyse" parameterType="java.lang.String" resultType="java.util.HashMap">
	<![CDATA[
	SELECT
	c.times as time,ifnull(d.1,0) as '1',ifnull(d.0,0) as '0' FROM(SELECT @num :=@num + 1 AS id,date_format(adddate(#{startTime},INTERVAL @num DAY),'%Y-%m-%d') AS times FROM
	s_qa_history,(SELECT @num :=- 1) t WHERE adddate(#{startTime},INTERVAL @num DAY) < date_format(#{endTime}, '%Y-%m-%d')) c LEFT JOIN (SELECT a.1,
	IfNULL(b.0, 0) AS '0',a.times as times FROM (SELECT COUNT(RECARD_ID) AS '1',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') 
	BETWEEN #{startTime} AND #{endTime} AND SATISIFIED_SCORE >= 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) a
	LEFT JOIN (SELECT COUNT(RECARD_ID) AS '0',date_format(CREATE_DATE, '%Y-%m-%d') AS times FROM s_qa_history WHERE date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	AND SATISIFIED_SCORE < 0 GROUP BY date_format(CREATE_DATE, '%Y-%m-%d')) b ON a.times = b.times) d ON c.times = d.times
	]]>
	</select>
	<select id="getSatisifiedList" resultType="java.util.LinkedHashMap">
	<![CDATA[
	SELECT RECARD_ID,USERID,INPUT,OUTPUT,MATCH_TYPE,SATISIFIED_SCORE,date_format(CREATE_DATE, '%Y-%m-%d %H:%i:%S') as time from s_qa_history WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN  #{startTime} AND  #{endTime}
	]]>
	<if test="excel == null">
	LIMIT #{page},#{size}
	</if>
	</select>
	<select id="getSatisifiedListTotle" resultType="java.util.HashMap">
	<![CDATA[
	SELECT COUNT(1) as totle from s_qa_history WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN  #{startTime} AND  #{endTime}
	]]>
	</select>
	
	
	
	<select id="getCityAnalyse"  resultType="java.util.HashMap">
	<![CDATA[
	SELECT
		COUNT(a.RECARD_ID) AS qatotle,
		b.LOCATION AS city
	FROM
		s_qa_history a ,s_user_info b
	WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	AND
		a.USERID = b.USER_ID
	GROUP BY
		b.LOCATION
	ORDER BY qatotle
	]]>
	</select>
	
	<select id="getCityAnalyseList" resultType="java.util.LinkedHashMap">
	<![CDATA[
	SELECT
		COUNT(DISTINCT(a.USERID)) AS usertotle,
		COUNT(a.RECARD_ID) AS qatotle,
		b.LOCATION AS city
	FROM
		s_qa_history a ,s_user_info b
	WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	AND
		a.USERID = b.USER_ID
	GROUP BY
		b.LOCATION
	ORDER BY usertotle
	]]>
	<if test="excel == null">
	LIMIT #{page},#{size}
	</if>
	</select>
	
	<select id="getCityAnalyseListTotle" resultType="java.util.HashMap">
	SELECT COUNT(1) AS totle FROM
	(<![CDATA[
	SELECT
		COUNT(LOCATION) AS totle
	FROM
		s_qa_history a ,s_user_info b
	WHERE
	date_format(CREATE_DATE, '%Y-%m-%d') BETWEEN #{startTime} AND #{endTime}
	AND
		a.USERID = b.USER_ID
	GROUP BY
		b.LOCATION
	]]>) a
	</select>
	
	<select id="getone" parameterType="java.lang.String" resultType="java.util.HashMap">
	select * from s_qa_history where 1=1 
	<if test="MATCHTYPEID != 'all'"> 
	AND MATCH_TYPEID in 
	<foreach collection="MATCHTYPEID" item="one" index="index"
            open="(" close=")" separator=",">
            #{one}
    </foreach>
    </if>
	</select>
	
	
	
	
</mapper>
